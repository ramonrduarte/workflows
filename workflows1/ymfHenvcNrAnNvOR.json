{
  "updatedAt": "2026-02-21T14:08:58.694Z",
  "createdAt": "2026-02-21T13:12:23.264Z",
  "id": "ymfHenvcNrAnNvOR",
  "name": "[EMKT] Chatwoot x UaZapi v1.1.0-Premium",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "content": "## Tratamento Inicial dos Dados",
        "height": 424,
        "width": 516
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1008,
        224
      ],
      "typeVersion": 1,
      "id": "d5456236-1132-4ac6-8299-4a287a1a80d2",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## InÃ­cio do Processamento",
        "height": 1256,
        "width": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        784,
        224
      ],
      "typeVersion": 1,
      "id": "56a69902-e646-4cd4-b55f-956c000c7d0f",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "```\n                                                                                  â–ˆâ–ˆâ–ˆ       â–ˆ                            â–ˆâ–ˆ          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ          â–ˆ                   â–ˆ              â–ˆ   â–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           â–ˆ\n                                                                                   â–ˆ       â–ˆâ–ˆâ–ˆ                                       â–ˆ     â–ˆ         â–ˆâ–ˆâ–ˆ                 â–ˆâ–ˆâ–ˆ             â–ˆ   â–ˆ          â–ˆ\n                                                                                   â–ˆ  â–ˆ â–ˆâ–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ     â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ     â–ˆ   â–ˆ    â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ           â–ˆ     â–ˆ    â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ\n                                                                                   â–ˆ  â–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆâ–ˆ      â–ˆ â–ˆ       â–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ    â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ     â–ˆ   â–ˆ    â–ˆ   â–ˆ      â–ˆ â–ˆ  â–ˆ â–ˆ          â–ˆâ–ˆ    â–ˆâ–ˆ    â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ       â–ˆ      â–ˆ   â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ   â–ˆ     â–ˆ    â–ˆ â–ˆ â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                   â–ˆ  â–ˆ  â–ˆ  â–ˆ  â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ    â–ˆ  â–ˆ â–ˆ  â–ˆ    â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ  â–ˆ  â–ˆ      â–ˆ â–ˆ     â–ˆ   â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ  â–ˆ â–ˆ  â–ˆ â–ˆ     â–ˆ â–ˆ   â–ˆ     â–ˆ    â–ˆ â–ˆ    â–ˆ    â–ˆ â–ˆ  â–ˆ    â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ  â–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                  â–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ  â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆ â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ    â–ˆ   â–ˆ    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ      â–ˆ   â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–ˆ    â–ˆ    â–ˆ  â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆ â–ˆ â–ˆ\n                                                                                                       â–ˆ             â–ˆ                                                                                         â–ˆ\n                                                                                                    â–ˆâ–ˆâ–ˆâ–ˆ            â–ˆ                                                                                          â–ˆ\n```",
        "height": 200,
        "width": 3132,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        0
      ],
      "typeVersion": 1,
      "id": "9b6169ed-b924-422e-8207-4415898b09cd",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Final do Processamento",
        "height": 1256,
        "width": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2928,
        224
      ],
      "typeVersion": 1,
      "id": "fa15f932-12cc-445f-901e-80b56e3b9f5b",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "251049eb-7cb5-454f-a495-072ab8d4f644",
              "leftValue": "={{ $('messageSentVerify')?.item?.json?.data?.attachments }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1392,
        768
      ],
      "id": "a0f7dc00-96b1-4083-8710-98dc331592a9",
      "name": "messageVerify"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2960,
        688
      ],
      "id": "d61f5255-27c8-4a44-a09a-a81874c187ea",
      "name": "endProcess"
    },
    {
      "parameters": {
        "content": "# ðŸ’¬ IntegraÃ§Ã£o Premium Chatwoot ðŸ” UaZapi\n### _**v1.1.0 â€¢ atualizado: 2025-12-02**_\n\n## Workflow que recebe mensagens via **webhook** do Chatwoot, normaliza os dados e envia para a UaZapi.\n---\n\n## ðŸ§­ O que este fluxo faz\n- Recebe **Webhook (POST)** do Chatwoot (`webhookDataChatwoot`) e carrega **variÃ¡veis de integraÃ§Ã£o** no Postgres (`getVariables`).\n- **Normaliza** contato, conversa e mensagem (`normalizedData`) e propaga para o contexto (`processedData`).\n- **Roteia** por tipo de entrega (`messageSentVerify` â†’ `messageVerify`):\n  - `msg_created` (evento `message_created` **sem** `source_id`)  \n    - **Texto:** `messageTextSend`  \n    - **MÃ­dia:** `messageMediaFields` â†’ `messageMediaSend`\n  - `msg_deleted` (evento `message_updated` com `deleted=true` **e** `delete_messages=true`)  \n    - Busca conteÃºdo original: `findMessageDeleted` â†’ valida direÃ§Ã£o (`deleteVerify`) â†’ apaga na UaZapi (`deleteMessage`) â†’ atualiza histÃ³rico no Chatwoot/DB com *strike-through* (`messageDeletedUpdate`)\n- ApÃ³s envio de texto **ou** mÃ­dia, atualiza o `source_id` no Postgres para manter o vÃ­nculo com a UaZapi (`messageUpdate`).\n- Assina a mensagem opcionalmente com o **nome do atendente** (flag `sign_messages`), e agrega `replyid` apenas quando **`reply_messages=true`** e houver `reply_id`.\n\n---\n\n## ðŸ›  Requisitos\n- **Postgres (credencial):** nÃ³s `getVariables` do Manager (Vermelho) e `messageUpdate`, `messageDeletedUpdate` do Chatwoot (Azuis).\n- **VariÃ¡veis de integraÃ§Ã£o (Preenchidas no Gerenciador de InstÃ¢ncias):**\n  - **Chatwoot:** `chatwoot_base_url`, `chatwoot_api_version`, `chatwoot_token`, `chatwoot_account_id`, `chatwoot_inbox_id`, `chatwoot_inbox_name`, `chatwoot_track_id`\n  - **UaZapi:** `api_base_url`, `api_token`, `api_instance_name`\n  - **ConfiguraÃ§Ãµes:** `ignore_groups`, `reply_messages`, `edit_messages`, `delete_messages`, `reopen_conversation`, `conversation_pending`, `import_*`, `sign_*`\n- **Chatwoot:** **Gere um cÃ³digo exclusivo para o seu webhook em** [UUID Generator](https://www.uuidgenerator.net/) e informe no campo `Path` do `webhookDataChatwoot`.\n\n---\n\n## âš™ï¸ InstalaÃ§Ã£o & AtivaÃ§Ã£o\n1. **Importe** o workflow no n8n.  \n2. Associe a **credencial Postgres** aos nÃ³s indicados.  \n3. Ajuste o **Webhook** `webhookDataChatwoot` (path pÃºblico) e configure os **webhooks de saÃ­da** no Chatwoot.  \n4. Confirme que `getVariables` retorna a linha correta por `chatwoot_account_id` e `chatwoot_inbox_id`.  \n5. **Save** â†’ **Activate**.  \n6. Envie uma mensagem pelo Chatwoot e valide o envio na UaZapi e a atualizaÃ§Ã£o do `source_id`.\n\n---\n\n## ðŸ”€ Regras de Roteamento (resumo)\n- **CriaÃ§Ã£o de mensagem:** `message_created` **sem** `source_id` â†’ envia para a UaZapi.  \n- **Texto vs MÃ­dia:** `messageVerify` checa `data_url`  \n  - vazio â†’ **texto** (`messageTextSend`)  \n  - preenchido â†’ **mÃ­dia** (`messageMediaFields` â†’ `messageMediaSend`)\n- **Reply:** `replyid` sÃ³ Ã© enviado se `reply_messages = true` **e** houver `reply_id`.\n- **Assinatura opcional:** quando `sign_messages = true`, prefixa o conteÃºdo com `*Atendente:*`.\n- **ExclusÃ£o:** `message_updated` com `deleted=true` **e** `delete_messages = true`  \n  - apenas se `direction = incoming` (`deleteVerify`)  \n  - apaga na UaZapi e grava histÃ³rico com *strike-through* no Chatwoot/DB.\n- **Rastreamento:** define `track_id` no formato `track-account-inbox` (com `account_id` e `inbox_id` **padStart(4)**) e `track_source = chatwoot`.\n\n---\n\n## ðŸ” SeguranÃ§a\n- **HTTPS** no Webhook e nas APIs (Chatwoot/UaZapi).\n- **Tokens** (Chatwoot/UaZapi) mantidos no Gerenciador de InstÃ¢ncias.\n",
        "height": 1984,
        "width": 768,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        224
      ],
      "typeVersion": 1,
      "id": "59792b91-b99e-457e-b232-533ab4b88798",
      "name": "Sticky Note Chatwoot â†’ UaZapi"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "6a936a6e-9056-465a-934f-e46564e5cbd3",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        864,
        352
      ],
      "id": "30a643ce-6311-4632-9ee7-cf26ea0ca498",
      "name": "webhookDataChatwoot",
      "webhookId": "6a936a6e-9056-465a-934f-e46564e5cbd3"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "chatwoot_uazapi",
          "mode": "list",
          "cachedResultName": "chatwoot_uazapi"
        },
        "table": {
          "__rl": true,
          "value": "chatwoot_uazapi_config",
          "mode": "list",
          "cachedResultName": "chatwoot_uazapi_config"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "chatwoot_account_id",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.account?.id ??\n           body?.messages?.[0]?.account_id ??\n           body?.conversation?.messages?.[0]?.account_id ??\n           0;\n  })()\n}}"
            },
            {
              "column": "chatwoot_inbox_id",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n    \n    return body?.conversation?.inbox_id \n        ?? body?.inbox_id \n        ?? 0;\n  })()\n}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1040,
        352
      ],
      "id": "04900508-d0b8-411b-9630-4bc1f25f0b3d",
      "name": "getVariables",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.messages\nSET \n  content = $1,\n  content_attributes = $2::json\nWHERE \n  id = $3::integer\nRETURNING \n  id, content, content_attributes;",
        "options": {
          "queryReplacement": "={{ [\n  String($('messageDeletedPrepare')?.item?.json?.new_content ?? ''),\n  String(JSON.stringify( $('messageDeletedPrepare')?.item?.json?.new_attributes ?? {} )),\n  String($('messageDeletedPrepare')?.item?.json?.message_id ?? 0)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2096,
        1168
      ],
      "id": "0d72d55c-72f0-467b-8500-0d009a8228fd",
      "name": "messageDeletedUpdate",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "content": "### Postgres Mngr",
        "height": 176,
        "width": 166,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1008,
        320
      ],
      "typeVersion": 1,
      "id": "a155d200-22d6-415a-a3cc-471f73b3a3f4",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "### Postgres Cwt",
        "height": 176,
        "width": 150,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1888,
        736
      ],
      "typeVersion": 1,
      "id": "53cca2c3-28ce-4fbe-ac3f-f95244a0d3a5",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "### Postgres Cwt",
        "height": 176,
        "width": 150,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2064,
        1136
      ],
      "typeVersion": 1,
      "id": "886eec21-ec02-4d28-917e-2bde45cbb492",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_created' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true &&\n  !String($('webhookDataChatwoot')?.item?.json?.body?.source_id ?? '').trim()\n}}",
                    "rightValue": "message_created",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "e71ede49-b811-46e9-be73-fcece40f27c8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "msg_created"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7bcd700f-3396-4c45-953c-8b5bcdf1bbbe",
                    "leftValue": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_updated' &&\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.content_attributes?.deleted === true ||\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.content_attributes?.deleted === true\n  ) &&  \n  $('webhookDataChatwoot')?.item?.json?.body?.message_type === 'outgoing' &&\n  $('processedData')?.item?.json?.chatwoot?.delete_messages === true\n}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "msg_deleted"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "920eac73-646e-4f71-976a-bf5c53718e5c",
                    "leftValue": "={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.event === 'conversation_typing_on' ||\n    $('webhookDataChatwoot')?.item?.json?.body?.event === 'conversation_typing_off'\n  ) &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true\n}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "msg_presence"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1216,
        960
      ],
      "id": "bb65a7c6-089a-4b45-9c30-67acdce2858f",
      "name": "messageSentVerify"
    },
    {
      "parameters": {
        "content": "# âš–ï¸ Aviso de Propriedade Intelectual & Suporte\n\nEste workflow e sua UI sÃ£o **propriedade intelectual** da EMKT Consultoria e Tecnologia, protegidos pelas Leis **9.610/98 (Direitos Autorais)**, **9.609/98 (Software)** e pela **LGPD â€“ 13.709/18**.\n---\n\n## Uso permitido\n- LicenÃ§a de **uso interno**, nÃ£o exclusiva e intransferÃ­vel.\n- Ã‰ vedada a **distribuiÃ§Ã£o**, **revenda**, **locaÃ§Ã£o**, **cessÃ£o**, **publicaÃ§Ã£o** ou **exposiÃ§Ã£o pÃºblica** (incl. repositÃ³rios/portais).\n\n## ProibiÃ§Ãµes\n- **CÃ³pia** total/parcial, **engenharia reversa**, **descompilaÃ§Ã£o**, **circunvenÃ§Ã£o** de proteÃ§Ãµes.\n- **ModificaÃ§Ãµes** nÃ£o autorizadas, criaÃ§Ã£o de **derivados** ou remoÃ§Ã£o de crÃ©ditos/identificaÃ§Ãµes.\n- **Compartilhamento** do pacote/fluxo, credenciais, URLs de webhook, telas ou prints com terceiros.\n\n## Suporte & Garantia\n- A **garantia de suporte** e atualizaÃ§Ãµes estÃ¡ **condicionada** Ã  manutenÃ§Ã£o do **estado original** do workflow.  \n- Qualquer **alteraÃ§Ã£o nÃ£o autorizada** (cÃ³digo, nÃ³s, credenciais, rotas, lÃ³gica ou layout) **invalida o suporte**.\n- AdequaÃ§Ãµes/integraÃ§Ãµes adicionais requerem **contrataÃ§Ã£o prÃ©via** e **autorizaÃ§Ã£o por escrito**.\n\n---\n\n### ðŸ“ž Contato\nPrecisa de ajuda? Fale conosco pelo WhatsApp Business  \n**(41) 9 8473-9797** â€” [abrir conversa](https://api.whatsapp.com/message/FVXDCWKJFIM4M1)  \n**(79) 9 9977-7712** â€” [abrir conversa](https://api.whatsapp.com/message/2G6M66MXFH7TD1)\n\n> DÃºvidas sobre uso, licenÃ§a ou autorizaÃ§Ã£o: contate a EMKT.\n",
        "height": 704,
        "width": 2352,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        784,
        1504
      ],
      "typeVersion": 1,
      "id": "4b1c942d-9c1f-410b-93b7-0025647b263b",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cef6a5a6-8219-4157-b619-78b9929ecc31",
              "leftValue": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_created' &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true &&\n  !String($('webhookDataChatwoot')?.item?.json?.body?.source_id ?? '').trim()\n}}",
              "rightValue": "message_created|message_updated",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "bf9dd4b4-6f2e-4628-ab0a-29f6b8b99c03",
              "leftValue": "={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.event === 'conversation_typing_on' ||\n    $('webhookDataChatwoot')?.item?.json?.body?.event === 'conversation_typing_off'\n  ) &&\n  $('webhookDataChatwoot')?.item?.json?.body?.private !== true\n}}",
              "rightValue": "messages",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "6921f65e-c71a-4c7d-bba8-31a3bfad3e87",
              "leftValue": "={{\n  // Verifica se Ã© um evento de atualizaÃ§Ã£o de mensagem\n  $('webhookDataChatwoot')?.item?.json?.body?.event === 'message_updated' &&\n  \n  // Verifica se hÃ¡ o atributo 'deleted' em algum dos locais possÃ­veis\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.content_attributes?.deleted === true ||\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.content_attributes?.deleted === true\n  ) &&\n  \n  // Verifica se a mensagem Ã© de saÃ­da (enviada por nÃ³s)\n  $('webhookDataChatwoot')?.item?.json?.body?.message_type === 'outgoing' &&\n  \n  // --- AQUI ESTÃ A LÃ“GICA DE FILTRAGEM ---\n  // 1. Permite se tiver o emoji de bloqueio (nossa formataÃ§Ã£o customizada)\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.content === 'Esta mensagem foi excluÃ­da' ||\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages[0]?.processed_message_content === 'Esta mensagem foi excluÃ­da'\n  )\n}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        1216,
        352
      ],
      "id": "20e81477-7429-4aef-91c1-9e1122ca9912",
      "name": "messageTypeFilter"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id }}/contacts",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"
            },
            {
              "name": "Content-type",
              "value": "application/json; charset=utf-8"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"{{ $('normalizedData')?.item?.json?.data?.is_group ? $('normalizedData')?.item?.json?.group?.name : $('normalizedData')?.item?.json?.contact?.full_name }}\",\n  \"inbox_id\": {{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id }},\n  \"source_id\": \"{{ $('contactAction')?.item?.json?.identifier?.split('@')?.first() }}\",\n  \"phone_number\": \"{{ $('normalizedData')?.item?.json?.contact?.phone_number_new }}\",\n  \"identifier\": \"{{ $('contactAction')?.item?.json?.identifier_new }}\",\n  \"additional_attributes\": {\n    \"contact_lid\": \"{{ $('contactAction')?.item?.json?.contact_lid_new }}\"\n  }\n}\n",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2448,
        272
      ],
      "id": "6bef005d-9e3d-43e4-b342-001ee5915bbe",
      "name": "contactCreate",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "23b01a4b-58a1-4256-b62f-373073a16840",
              "name": "identifier",
              "value": "={{ $('contactAction')?.item?.json?.identifier_new }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2624,
        352
      ],
      "id": "31242e56-14d6-482c-967d-26c406d17d22",
      "name": "contactIdentify",
      "retryOnFail": true
    },
    {
      "parameters": {
        "content": "### Postgres Cwt",
        "height": 176,
        "width": 166,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2064,
        320
      ],
      "typeVersion": 1,
      "id": "f978a051-ff38-473e-8780-21dc33f91bbb",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH NormalizedInput AS (\n  SELECT\n    NULLIF($1, '') AS input_identifier,\n    NULLIF($2, '') AS input_lid,\n    NULLIF($3, '') AS input_full_name,\n    NULLIF($4, '') AS input_phone_number,\n    NULLIF($5, '')::integer AS input_account_id\n)\nSELECT\n  COALESCE(c.id, 0) AS contact_id,\n  COALESCE(c.identifier, '') AS identifier_old,\n  COALESCE(ni.input_identifier, '') AS identifier_new,\n  COALESCE(c.additional_attributes ->> 'contact_lid', '') AS contact_lid_old,\n  COALESCE(ni.input_lid, '') AS contact_lid_new,\n  COALESCE(c.name, '') AS name_old,\n  COALESCE(ni.input_full_name, '') AS name_new,\n  COALESCE(c.phone_number, '') AS phone_number_old,\n  COALESCE(ni.input_phone_number, '') AS phone_number_new,\n  CASE\n    WHEN c.id IS NULL THEN true\n    WHEN \n      (\n        COALESCE(c.identifier, '') != COALESCE(ni.input_identifier, '') OR\n        COALESCE(c.additional_attributes ->> 'contact_lid', '') != COALESCE(ni.input_lid, '') OR\n        COALESCE(c.phone_number, '') != COALESCE(ni.input_phone_number, '')\n      )\n    THEN true\n    WHEN \n      (\n        COALESCE(c.name, '') = 'Contato' AND\n        COALESCE(c.name, '') != COALESCE(ni.input_full_name, '')\n      )\n    THEN true\n    ELSE false\n  END AS update_data\nFROM\n  NormalizedInput AS ni\nLEFT JOIN\n  contacts AS c ON\n    (c.account_id = ni.input_account_id AND ni.input_account_id IS NOT NULL)\n    AND\n    (\n      (c.identifier = ni.input_identifier AND ni.input_identifier IS NOT NULL)\n      OR\n      (c.additional_attributes ->> 'contact_lid' = ni.input_lid AND ni.input_lid IS NOT NULL)\n      OR\n      (c.phone_number = ni.input_phone_number AND ni.input_phone_number IS NOT NULL)\n    );",
        "options": {
          "queryReplacement": "={{ [\n  String((() => {\n    try {\n      const jid = $('contactVerify')?.item?.json?.jid;\n      if (jid) return jid;\n    } catch (e) {}\n    return $('normalizedData')?.item?.json?.contact?.identifier ?? '';\n  })()),\n  String((() => {\n    try {\n      const lid = $('contactVerify')?.item?.json?.lid;\n      if (lid) return lid;\n    } catch (e) {}\n    return $('normalizedData')?.item?.json.contact.lid ?? '';\n  })()),\n  String($('normalizedData')?.item?.json?.contact?.full_name ?? ''),\n  String($('normalizedData')?.item?.json?.contact?.phone_number ?? ''),\n  String($('normalizedData')?.item?.json?.chatwoot?.account_id ?? '')\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2096,
        352
      ],
      "id": "c8c70f2f-ba44-4dbc-b2de-06c4d05d2d2b",
      "name": "contactFind",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "contacts",
          "mode": "list",
          "cachedResultName": "contacts"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "identifier": "={{ $('contactAction')?.item?.json?.identifier_new }}",
            "id": "={{ $('contactAction')?.item?.json?.contact_id }}",
            "additional_attributes": "={{ ({ \"contact_lid\": $('contactAction')?.item?.json?.contact_lid_new }) }}",
            "name": "={{\n(() => {\n  const data = $('contactAction')?.item?.json ?? {};\n  \n  const oldName = data?.name_old ?? '';\n  const newName = data?.name_new ?? '';\n  if (oldName === 'Contato') {\n    return newName;\n  }\n  return oldName;\n})()\n}}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "name",
              "displayName": "name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "phone_number",
              "displayName": "phone_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "account_id",
              "displayName": "account_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "additional_attributes",
              "displayName": "additional_attributes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "identifier",
              "displayName": "identifier",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "custom_attributes",
              "displayName": "custom_attributes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_activity_at",
              "displayName": "last_activity_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "contact_type",
              "displayName": "contact_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "middle_name",
              "displayName": "middle_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "last_name",
              "displayName": "last_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "location",
              "displayName": "location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "country_code",
              "displayName": "country_code",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "blocked",
              "displayName": "blocked",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "company_id",
              "displayName": "company_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2448,
        432
      ],
      "id": "4b81f5fa-fc10-4ff8-ac9b-3111a1ed68f1",
      "name": "contactUpdate",
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "content": "### Postgres Cwt",
        "height": 176,
        "width": 166,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2416,
        400
      ],
      "typeVersion": 1,
      "id": "1b01971d-305b-4f82-8b42-e43699ab0422",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## Tratamento do Contato",
        "height": 424,
        "width": 1380
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1536,
        224
      ],
      "typeVersion": 1,
      "id": "f578c501-f14a-44b1-871c-a803635804df",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Tratamento da Mensagem",
        "height": 824,
        "width": 1908
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1008,
        656
      ],
      "typeVersion": 1,
      "id": "e4aed36d-c3f0-4f1d-9a42-1e6b11e5804f",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.api?.base_url }}/chat/check",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('normalizedData')?.item?.json?.api?.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"numbers\": [\n    \"{{ $('normalizedData')?.item?.json?.contact?.phone_number }}\"\n  ]\n}",
        "options": {}
      },
      "id": "ab65ab3e-7569-4ac5-a987-687f08c61e59",
      "name": "contactValidation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1744,
        432
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{\n  (\n    $('contactFind')?.item?.json ??\n    {}\n  )\n  .contact_id === 0\n}}",
                    "rightValue": 0,
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "e71ede49-b811-46e9-be73-fcece40f27c8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "create"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "342366cd-05e8-4efe-b237-ccf032377806",
                    "leftValue": "={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data?.contact_id > 0);\n  const shouldUpdate = (data?.update_data !== true);\n  return contactIdExists && shouldUpdate;\n})()\n}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "exists"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7bcd700f-3396-4c45-953c-8b5bcdf1bbbe",
                    "leftValue": "={{\n(() => {\n  const data = $('contactFind')?.item?.json ?? {};\n  const contactIdExists = (data?.contact_id > 0);\n  const shouldUpdate = (data?.update_data === true);\n  return contactIdExists && shouldUpdate;\n})()\n}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "update"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2272,
        336
      ],
      "id": "c52ab086-7f29-4286-89e2-dfb15ec5b143",
      "name": "contactAction"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2ec9a8fb-a140-4361-80c0-8d8f797bf409",
              "leftValue": "={{ $('contactValidation')?.item?.json?.isInWhatsapp }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1920,
        432
      ],
      "id": "5edf6089-b3ff-4a35-8cc9-d557e92867c7",
      "name": "contactVerify"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "342366cd-05e8-4efe-b237-ccf032377806",
                    "leftValue": "={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}",
                    "rightValue": "g.us",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "group"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}",
                    "rightValue": "s.whatsapp.net",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e71ede49-b811-46e9-be73-fcece40f27c8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "jid"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7bcd700f-3396-4c45-953c-8b5bcdf1bbbe",
                    "leftValue": "={{ $('normalizedData')?.item?.json?.contact?.identifier?.split('@').last() }}",
                    "rightValue": "lid",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "lid"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1568,
        320
      ],
      "id": "f3211e1d-6c32-4733-a386-f7b809a38498",
      "name": "identifierVerify"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('normalizedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('normalizedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('normalizedData')?.item?.json?.data?.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('normalizedData')?.item?.json?.chatwoot?.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{\n(() => {\n  // 1. Pega os dados do contato de forma segura\n  const contact = $('normalizedData')?.item?.json?.contact ?? {};\n  \n  // 2. Extrai os dados (com fallback para 'N/A' se estiverem vazios)\n  const name = contact.full_name || 'N/A';\n  const phone = contact.phone_number || 'N/A';\n\n  // 3. Monta o card de erro formatado\n  const card = [];\n  \n  // TÃ­tulo sugestivo com emoji\n  card.push(`âŒ **Falha ao Enviar: Contato InvÃ¡lido**`);\n  card.push(`\\n---\\n`);\n  card.push(`NÃ£o foi possÃ­vel enviar a mensagem. O contato abaixo parece ter um nÃºmero de WhatsApp invÃ¡lido ou inexistente.`);\n  \n  // InformaÃ§Ãµes (sem o identifier)\n  card.push(`\\n**Nome:** ${name}`);\n  card.push(`**Telefone:** ${phone}`);\n  card.push(`\\n---\\n`);\n  \n  // Texto final com a instruÃ§Ã£o\n  card.push(`_**AÃ§Ã£o Recomendada:** Verifique se o nÃºmero de telefone estÃ¡ correto (incluindo DDI + DDD), ajuste o cadastro do contato e tente enviar a mensagem novamente._`);\n\n  return card.join('\\n');\n})()\n}}"
            },
            {
              "name": "message_type",
              "value": "=incoming"
            },
            {
              "name": "source_id",
              "value": "={{ $('normalizedData').item.json.data.message_id }}"
            },
            {
              "name": "private",
              "value": "={{ true }}"
            }
          ]
        },
        "options": {}
      },
      "id": "a372b5ea-48d8-457c-af18-183f989f3b25",
      "name": "contactMessage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2096,
        512
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.api?.base_url }}/send/text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('normalizedData')?.item?.json?.api?.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('processedData')?.item?.json?.contact?.identifier }}\",\n  \"text\": \"{{ ((\n               $('processedData')?.item?.json?.integration?.sign_messages_mode !== 'none' &&\n               $('processedData')?.item?.json?.data?.sender\n             )\n             ? (\n                 '*' +\n                 ( $('processedData')?.item?.json?.data?.sender ?? '' ) +\n                 ':*' +\n                 ( $('processedData')?.item?.json?.integration?.sign_delimiter ?? '\\\\n' )\n               )\n             : ''\n           ) +\n           String($('processedData')?.item?.json?.data?.content ?? '')\n             .replace(/\\\\n/g, '\\\\n')\n  }}\",\n  \"readchat\": {{ String($('normalizedData')?.item?.json?.integration?.mark_read) === 'true' }},\n  \"replyid\": \"{{\n                $('processedData')?.item?.json?.chatwoot?.reply_messages === true &&\n                String($('processedData')?.item?.json?.data?.reply_id ?? '')\n                  .trim()\n                  .length > 0\n                ? $('processedData')?.item?.json?.data?.reply_id\n                : ''\n              }}\",\n  \"track_id\": \"{{\n                 `${$('getVariables')?.item?.json?.chatwoot_track_id ?? ''}` +\n                 '-' +\n                 `${String($('getVariables')?.item?.json?.chatwoot_account_id ?? '').padStart(4,'0')}` +\n                 '-' +\n                 `${String($('getVariables')?.item?.json?.chatwoot_inbox_id ?? '').padStart(4,'0')}`\n               }}\",\n  \"track_source\": \"chatwoot\"\n}",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "id": "40cb3269-4d99-420e-83bc-e562d29de570",
      "name": "messageTextSend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1568,
        688
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('processedData')?.item?.json?.api.base_url }}/send/media",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('processedData')?.item?.json?.api?.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('processedData')?.item?.json?.contact?.identifier }}\",\n  \"text\": \"{{ (( $('processedData')?.item?.json?.integration?.sign_messages_mode !== 'none' &&\n               $('processedData')?.item?.json?.data?.sender )\n               ? ('*' + ( $('processedData')?.item?.json?.data?.sender ?? '' ) + \n                 ':*' + ( $('processedData')?.item?.json?.integration?.sign_delimiter ?? '\\\\n' ))\n               : '' ) +\n             String($('messageMediaFields')?.item?.json?.data?.content ?? '')\n               .replace(/\\n/g,'\\\\n')\n           }}\",\n  \"readchat\": {{ String($('normalizedData')?.item?.json?.integration?.mark_read) === 'true' }},\n  \"replyid\": \"{{\n    $('processedData')?.item?.json?.chatwoot?.reply_messages === true &&\n    String($('processedData')?.item?.json?.data?.reply_id ?? '')\n      .trim()\n      .length > 0\n      ? $('processedData')?.item?.json?.data?.reply_id\n      : ''\n  }}\",\n  \"type\": \"{{ $('messageMediaFields')?.item?.json?.type }}\",\n  \"file\": \"{{ $('messageMediaFields')?.item?.json?.url }}\",\n  \"docName\": \"{{ $('messageMediaFields')?.item?.json?.filename }}\",\n  \"track_id\": \"{{\n    `${$('getVariables')?.item?.json?.chatwoot_track_id ?? ''}` +\n    '-' +\n    `${String($('getVariables')?.item?.json?.chatwoot_account_id ?? '').padStart(4, '0')}` +\n    '-' +\n    `${String($('getVariables')?.item?.json?.chatwoot_inbox_id ?? '').padStart(4, '0')}`\n  }}\",\n  \"track_source\": \"chatwoot\"\n}\n",
        "options": {}
      },
      "id": "20510772-e5e2-4e66-abc3-b60cf44fd008",
      "name": "messageMediaSend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2096,
        928
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "77c8dae6-2659-438d-b2ac-7b8d5a256165",
              "name": "url",
              "value": "={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.data_url }}",
              "type": "string"
            },
            {
              "id": "eaa9ebf4-e2af-4926-b821-100da4776575",
              "name": "filename",
              "value": "={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.filename }}",
              "type": "string"
            },
            {
              "id": "6668f3d0-2066-43ac-ba7b-b905c3d6fbc0",
              "name": "type",
              "value": "={{ $('messageMediaLoop')?.item?.json?.currentAttachment?.file_type }}",
              "type": "string"
            },
            {
              "id": "9c331318-54a8-4bef-8ac3-bd23482c5bed",
              "name": "mimeType",
              "value": "={{ \n  (() => {\n    const type = $('messageMediaLoop')?.item?.json?.currentAttachment?.filename.split('.').last();\n    switch (type) {\n      case 'doc': return 'application/msword';\n      case 'docx': return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n      case 'jpeg': return 'image/jpeg';\n      case 'jpg': return 'image/jpeg';\n      case 'mp3': return 'audio/ogg; codecs=opus';\n      case 'mp4': return 'video/mp4';\n      case 'ogg': return 'audio/ogg; codecs=opus';\n      case 'pdf': return 'application/pdf';\n      case 'pfx': return 'application/x-pkcs12';\n      case 'png': return 'image/png';\n      case 'rar': return 'application/vnd.rar';\n      case 'xls': return 'application/vnd.ms-excel';\n      case 'xlsx': return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n      case 'zip': return 'application/zip';\n      default: return 'application/octet-stream';\n    }\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "f8e63388-2dc7-4905-82d5-d77f82b6e4e2",
              "name": "data.content",
              "value": "={{ \n  $('messageMediaLoop')?.item?.json?.currentAttachment?.content ??\n  ''\n}}",
              "type": "string"
            },
            {
              "id": "78c3514c-ec46-4f05-a5c3-86fc31e79122",
              "name": "item",
              "value": "={{\n  $('messageMediaLoop')?.item?.json?.currentAttachment?.item ??\n  ''\n}}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1920,
        928
      ],
      "id": "4a065090-9a53-4f23-8d8b-784c3e39aafb",
      "name": "messageMediaFields"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('messageVerify')?.item?.json?.conversation_id || $('processedData')?.item?.json?.data?.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.token }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "=attachments[]",
              "inputDataFieldName": "data"
            },
            {
              "name": "message_type",
              "value": "={{ $('processedData')?.item?.json?.data?.direction }}"
            },
            {
              "name": "source_id",
              "value": "={{ $('messageMediaSend')?.item?.json?.messageid }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4b599bb4-dfb1-4c44-8b7f-043b30bee67d",
      "name": "createMessageInChatwoot",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2624,
        848
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $('messageMediaFields')?.item?.json?.url }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2448,
        848
      ],
      "id": "f74f3a7f-dedc-40e3-8b2d-81b30cb11d16",
      "name": "messageMediaDownload",
      "retryOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "16c3d6c6-556b-4ba0-abc3-406f76b662d0",
              "leftValue": "={{ $('messageMediaFields')?.item?.json?.item }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2272,
        928
      ],
      "id": "a5b0d80f-fd2b-44c4-b966-f7b201bca82a",
      "name": "messageMediaVerify"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH updated AS (\n  UPDATE public.messages\n  SET source_id = $1\n  WHERE id = $2::integer\n  RETURNING id, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;",
        "options": {
          "queryReplacement": "={{ [\n  String($json?.messageid ?? ''),\n  String($('processedData')?.item?.json?.data?.message_id ?? 0)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2800,
        848
      ],
      "id": "1075ebd2-864d-44c6-becb-72b05e87cde1",
      "name": "messageMediaUpdate",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH updated AS (\n  UPDATE public.messages\n  SET source_id = $1\n  WHERE id = $2::integer\n  RETURNING id, source_id\n)\nSELECT\n  (SELECT COUNT(*) FROM updated) AS rows_affected,\n  (SELECT source_id FROM updated LIMIT 1) AS source_id;",
        "options": {
          "queryReplacement": "={{ [\n  String($json?.messageid ?? $('messageMediaLoop')?.item?.json?.messageid ?? ''),\n  String($('processedData')?.item?.json?.data.message_id ?? 0)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2096,
        688
      ],
      "id": "48b2a0de-0d7e-4916-a0eb-d8b9821fc05d",
      "name": "messageTextUpdate",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fc173b4d-2b51-446a-a545-36fe4fc3f9e9",
              "name": "chatwoot",
              "value": "={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:        s.chatwoot_base_url,\n    api_version:     s.chatwoot_api_version,\n    token:           s.chatwoot_token,\n    account_id:      s.chatwoot_account_id,\n    inbox_id:        s.chatwoot_inbox_id,\n    inbox_name:      s.chatwoot_inbox_name,\n    track_id:        s.chatwoot_track_id,\n    reply_messages:  s.reply_messages,\n    edit_messages:   s.edit_messages,\n    delete_messages: s.delete_messages\n  };\n})() }}",
              "type": "object"
            },
            {
              "id": "365992ef-324c-45f6-8770-032326a3467e",
              "name": "api",
              "value": "={{ $('normalizedData')?.item?.json?.api }}",
              "type": "object"
            },
            {
              "id": "f9308e51-fcdd-4475-9d60-78546896588d",
              "name": "integration",
              "value": "={{ $('normalizedData')?.item?.json?.integration }}",
              "type": "object"
            },
            {
              "id": "cb473388-9aaf-46a8-86fe-c9c37776ed65",
              "name": "contact",
              "value": "={{ $('normalizedData')?.item?.json?.contact }}",
              "type": "object"
            },
            {
              "id": "7cef8d6a-13c6-4c6b-bcf1-81e60a5a1d37",
              "name": "data",
              "value": "={{ $('normalizedData').item?.json?.data }}",
              "type": "object"
            },
            {
              "id": "fed18daf-ce00-4acf-b20d-b57a4a366939",
              "name": "contact.identifier",
              "value": "={{ $('contactIdentify')?.item?.json?.identifier ?? '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1040,
        960
      ],
      "id": "599b983d-fa58-4242-94d9-baddd911d359",
      "name": "processedData"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "37609540-0631-4eb3-808b-a2b20f1b90a2",
              "name": "chatwoot",
              "value": "={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:   s.chatwoot_base_url,\n    api_version:s.chatwoot_api_version,\n    token:      s.chatwoot_token,\n    account_id: s.chatwoot_account_id,\n    inbox_id:   s.chatwoot_inbox_id,\n    inbox_name: s.chatwoot_inbox_name,\n    track_id:   s.chatwoot_track_id,\n  };\n})() }}",
              "type": "object"
            },
            {
              "id": "84596df0-c964-4e49-b538-07f44c2957d9",
              "name": "api",
              "value": "={{ (() => {\n  const s = $('getVariables')?.item?.json;\n  return {\n    base_url:          s.api_base_url,\n    token:             s.api_token,\n    api_instance_name: s.api_instance_name,\n  };\n})() }}",
              "type": "object"
            },
            {
              "id": "4260e205-91f4-4f15-9263-27bdcd4e29d1",
              "name": "integration",
              "value": "={{ (() => {\n  const s = $('getVariables')?.item?.json ?? {};\n  return {\n    ignore_groups:        s.ignore_groups ?? false,\n    reply_messages:       s.reply_messages ?? false,\n    edit_messages:        s.edit_messages ?? false,\n    delete_messages:      s.delete_messages ?? false,\n    reopen_conversation:  s.reopen_conversation ?? false,\n    conversation_pending: s.conversation_pending ?? false,\n    import_contacts:      s.import_contacts ?? false,\n    import_messages:      s.import_messages ?? false,\n    import_days_limit:    s.import_days_limit ?? 0,\n    sign_messages:        s.sign_messages ?? false,\n    sign_delimiter:       s.sign_delimiter ?? '',\n    reject_calls:         s.reject_calls ?? false,\n    reject_msg:           s.reject_msg ?? '',\n    mark_read:            s.mark_read ?? false,\n    read_status:          s.read_status ?? false\n  };\n})() }}",
              "type": "object"
            },
            {
              "id": "92edb1f3-4c01-43c1-ab66-5bae3b88272a",
              "name": "contact.contact_id",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.conversation?.contact_inbox?.contact_id ??\n           body?.contact_inbox?.contact_id ??\n           0;\n  })()\n}}",
              "type": "number"
            },
            {
              "id": "e058c51f-71a0-43f3-8cae-448a8c1ccfb2",
              "name": "contact.identifier",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.conversation?.meta?.sender?.identifier ??\n           body?.meta?.sender?.identifier ??\n           '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "bd2a4034-caa8-4a5e-96dc-1d44dd6dc107",
              "name": "contact.lid",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.sender?.additional_attributes?.contact_lid ??\n           body?.conversation?.meta?.sender?.additional_attributes?.contact_lid ??\n           body?.meta?.sender?.identifier\n           '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "5c9147af-3eba-4ca4-9112-205261f7a4cc",
              "name": "contact.phone_number",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.conversation?.meta?.sender?.phone_number ??\n           body?.meta?.sender?.phone_number ??\n           '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "4832617f-aafc-4cbf-8fa5-e2502deb7143",
              "name": "contact.full_name",
              "value": "={{\n  (\n    $('webhookDataChatwoot')?.item?.json?.body?.conversation?.meta?.sender?.name ||\n    ''\n  )\n  .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n  .trim()\n  ||\n  'Contato'\n}}",
              "type": "string"
            },
            {
              "id": "4a7df58d-d6f7-42ba-a09d-5b04910c0555",
              "name": "contact.first_name",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    const rawName = body?.conversation?.meta?.sender?.name ??\n                    body?.meta?.sender?.name ??\n                    '';\n\n    return rawName\n           .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n           .trim()\n           .split(/\\s+/)[0] ||\n           'Contato';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "feb8da01-d39a-4571-a215-c93f838b1cd6",
              "name": "contact.middle_name",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    const rawName = body?.conversation?.meta?.sender?.name ??\n                    body?.meta?.sender?.name ??\n                    '';\n\n    return rawName\n           .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n           .trim()\n           .split(/\\s+/)\n           .slice(1, -1)\n           .join(' ') ||\n           ''\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "13f61b17-5053-42d7-a613-ac7ab0cfabc3",
              "name": "contact.last_name",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    const rawName = body?.conversation?.meta?.sender?.name ??\n                    body?.meta?.sender?.name ??\n                    '';\n\n    return rawName\n           .replace(/[^a-zA-ZÃ€-Ã¿\\s]/g, '')\n           .trim()\n           .split(/\\s+/)\n           .slice(-1)[0] ||\n           ''\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "23e6b810-0252-4617-bf33-5ef2a8bdb715",
              "name": "data.message_type",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.conversation?.messages?.[0]?.content_type ??\n           body?.messages?.[0]?.content_type ??\n           '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "cfba5c5e-18cf-4f29-9840-561c1f5a2be8",
              "name": "data.content",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    // Verifica se Ã© CSAT\n    const isCsat = body?.content_attributes?.content_type === 'input_csat' ||\n                   body?.content_type === 'input_csat';\n\n    // Extrai o texto base\n    const rawText = isCsat ?\n                    body?.content :\n                    body?.conversation?.messages?.[0]?.content ??\n                    body?.messages?.[0]?.content ??\n                    '';\n\n    return String(rawText)\n      // =================================================================\n      // 1. LIMPEZA DE CARACTERES\n      // =================================================================\n      \n      // Remove caracteres de controle e invisÃ­veis (agrupados para performance)\n      .replace(/[\\v\\f\\u200B\\uFEFF]/g, '')\n      // TabulaÃ§Ã£o vira espaÃ§o\n      .replace(/\\t/g, ' ')\n      // Normaliza quebras de linha (Windows/Mac -> Unix)\n      .replace(/\\r\\n|\\r/g, '\\n')\n      // Normaliza espaÃ§o nÃ£o quebrÃ¡vel\n      .replace(/\\u00A0/g, ' ')\n\n      // =================================================================\n      // 2. CONVERSÃƒO MARKDOWN (Chatwoot -> WhatsApp)\n      // =================================================================\n\n      // Links: [Texto](Url) -> Texto (Url)\n      .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '$1 ($2)')\n      \n      // Negrito: **texto** -> *texto* (Usa marcador para proteger do itÃ¡lico)\n      .replace(/\\*\\*(.*?)\\*\\*/g, '@@BOLD@@$1@@BOLD@@')\n      \n      // ItÃ¡lico: *texto* -> _texto_\n      .replace(/\\*(.*?)\\*/g, '_$1_')\n      \n      // Riscado: ~~texto~~ -> ~texto~\n      .replace(/~~(.*?)~~/g, '~$1~')\n      \n      // CÃ³digo: `texto` -> ```texto```\n      .replace(/`(.*?)`/g, '```$1```')\n      \n      // Restaura o Negrito\n      .replace(/@@BOLD@@/g, '*')\n\n      // =================================================================\n      // 3. ESCAPE PARA JSON\n      // =================================================================\n      \n      .replace(/\\\\/g, '\\\\\\\\')\n      .replace(/\\n/g, '\\\\n')\n      .replace(/\"/g, '\\\\\"');\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "e4dd23d8-5edd-47b1-8cd6-6781e3d3cd8f",
              "name": "data.direction",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    const value = body?.message_type ??\n                  body?.conversation?.messages?.[0]?.message_type;\n\n    const map = {\n      0: 'incoming',\n      1: 'outgoing'\n    };\n\n    return map[value] ?? value ?? '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "6d663b17-95eb-43bd-ab52-7ba010c5c5a9",
              "name": "data.conversation_id",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.conversation?.id ??\n           body?.messages?.[0]?.conversation_id ??\n           0;\n  })()\n}}",
              "type": "number"
            },
            {
              "id": "53ee35f4-904a-4ba4-822c-9121e9a7a37a",
              "name": "data.sender",
              "value": "={{ (() => {\n  const mode = $('getVariables')?.item?.json?.sign_messages_mode\n  const assignee = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.meta?.assignee;\n  const sender = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.sender;\n  let signatureName = '';\n  if (mode === 'assigned_name' && assignee) {\n    signatureName = assignee.name || '';\n  } else if (mode === 'assigned_display_name' && assignee) {\n    signatureName = assignee.available_name || assignee.name || '';\n  } else if (mode === 'logged_name' && sender) {\n    signatureName = sender.name || '';\n  } else if (mode === 'logged_display_name' && sender) {\n    signatureName = sender.available_name || sender.name || '';\n  } else {\n    signatureName = '';\n  }\n  return signatureName;\n})() }}",
              "type": "string"
            },
            {
              "id": "e1ec8f48-5b4f-4a89-8959-81673f82c33d",
              "name": "data.message_id",
              "value": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.id ??\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation.messages?.[0]?.id ??\n  0\n}}",
              "type": "number"
            },
            {
              "id": "f69ec58f-0da7-45b7-b627-2dc82fc80710",
              "name": "data.source_id",
              "value": "={{\n  (() => {\n    const body = $('webhookDataChatwoot')?.item?.json?.body;\n\n    return body?.source_id ??\n           body?.conversation?.messages?.[0]?.source_id ??\n           body?.messages?.[0]?.source_id ??\n           '';\n  })()\n}}",
              "type": "string"
            },
            {
              "id": "9d2180ef-94d4-40cf-90df-e073d84bbf3b",
              "name": "data.reply_id",
              "value": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.content_attributes?.in_reply_to_external_id ??\n  ''\n}}",
              "type": "string"
            },
            {
              "id": "e583d428-c4a5-4342-b898-5491fabd52cc",
              "name": "data.status",
              "value": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.conversation?.status ??\n  ''\n}}",
              "type": "string"
            },
            {
              "id": "f27ee0aa-d24e-4660-bd9e-387c1791a9a9",
              "name": "data.event_type",
              "value": "={{\n  $('webhookDataChatwoot')?.item?.json?.body?.event ??\n  ''\n}}",
              "type": "string"
            },
            {
              "id": "f5b05f21-2a5a-4761-ad6e-6bd7073f422f",
              "name": "data.attachments",
              "value": "={{(() => {\n  const attachments = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.attachments ?? [];\n  \n  // Se nÃ£o houver anexos, retorna um array vazio\n  if (attachments.length === 0) return [];\n\n  // Mapeia todos os attachments do Chatwoot\n  return attachments.map((att, index) => ({\n    data_url: att.data_url,\n    file_type: att.file_type.replace('file','document').replace('audio','ptt'),\n    filename: decodeURIComponent(att.data_url?.split('/')?.pop() ?? 'file'),\n  }));\n})()}}",
              "type": "array"
            },
            {
              "id": "6ede662e-f7fb-415b-ad12-d6792eda567b",
              "name": "data.created_at",
              "value": "={{(() => {\n  const ts = $('webhookDataChatwoot')?.item?.json?.body?.conversation?.messages?.[0]?.created_at;\n  if (!ts) return null; // Evita erro se o valor nÃ£o existir\n  const timestamp = Number(ts) * 1000; // Converte de segundos para milissegundos\n  return new Date(timestamp).toISOString();\n})()}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "abf3acef-1627-4c1e-84c5-3ceb34d9fcd8",
      "name": "normalizedData",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1392,
        352
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "content": "### Postgres Cwt",
        "height": 176,
        "width": 150,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2064,
        656
      ],
      "typeVersion": 1,
      "id": "5b2e3c6e-aa8a-468c-b1c5-8b6b3ef26764",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "### Postgres Cwt",
        "height": 176,
        "width": 150,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2768,
        816
      ],
      "typeVersion": 1,
      "id": "52471386-af7f-45a1-845f-461ff0b3eaf8",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "jsCode": "const item = $('processedData')?.first()?.json;\n\n// Extrai o array de attachments do item atual\nconst attachmentsArray = item?.data?.attachments ?? [];\n\nreturn attachmentsArray.map((att, index) => ({\n  currentAttachment: {\n    data_url: att.data_url,\n    file_type: att.file_type,\n    filename: att.filename,\n    content: index === 0 ? $input?.first()?.json?.data.content : '',\n    item: index\n  },\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        848
      ],
      "id": "dbedd530-cb57-4755-ac3d-2e820d1fe3f0",
      "name": "messageMediaSplit"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1744,
        848
      ],
      "id": "b04cfa37-b925-4752-ab6f-ab0e79ba9787",
      "name": "messageMediaLoop"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH deleted_attachments AS (\n  DELETE FROM attachments\n  WHERE message_id = $1::integer\n  AND id != (\n      SELECT MIN(id)\n      FROM attachments\n      WHERE message_id = $1::integer\n  )\n  RETURNING id\n)\nSELECT COUNT(*) AS total_attachments_removed\nFROM deleted_attachments;",
        "options": {
          "queryReplacement": "={{ [\n  String($('processedData')?.item?.json?.data?.message_id ?? 0)\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1920,
        768
      ],
      "id": "516ba007-1cd4-4a0f-b4e6-e057b437ad19",
      "name": "messageMediaRemove",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hwa2nCsFNLchnlRz",
          "name": "Postgres Chatwoot"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.api?.base_url }}/message/find",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('normalizedData')?.item?.json?.api?.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('normalizedData')?.item?.json?.contact?.identifier }}\",\n  \"id\": \"{{ $('processedData')?.item?.json?.data?.source_id }}\"\n}",
        "options": {}
      },
      "id": "f2521712-40ab-4b4e-b76f-f54ae4f1a34a",
      "name": "messageDeletedFind",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1392,
        1168
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Pega o item atual\nconst item = $input?.item;\nconst root = item.json ?? {};\nconst msg  = root.messages?.[0] ?? {};\nconst c    = msg.content ?? {};\n\n// =================================================================\n// 1. FUNÃ‡ÃƒO AUXILIAR: ConversÃ£o de Markdown (WhatsApp -> Chatwoot)\n// =================================================================\nconst convertMarkdown = (text) => {\n  if (typeof text !== 'string' || !text) return '';\n\n  return text\n    // --- LIMPEZA ---\n    .replace(/\\t/g, ' ').replace(/\\v/g, '').replace(/\\f/g, '')\n    .replace(/\\u200B/g, '').replace(/\\uFEFF/g, '').replace(/\\r/g, '')\n    .replace(/\\u00A0/g, ' ')\n    // --- CONVERSÃƒO MARKDOWN ---\n    .replace(/```(.*?)```/gs, '`$1`')\n    .replace(/\\*(.*?)\\*/gs, '**$1**')\n    .replace(/_(.*?)_/gs, '*$1*')\n    .replace(/~(.*?)~/gs, '~~$1~~')\n    // --- LIMPEZA FINAL ---\n    .trim();\n};\n\n// =================================================================\n// 2. FUNÃ‡ÃƒO AUXILIAR: FormataÃ§Ã£o de Moeda\n// =================================================================\nconst formatCurrency = (value, offset, currencyCode = 'BRL') => {\n  if (value === undefined || value === null) return '';\n  const divisor = offset || 1000;\n  const realValue = value / divisor;\n  if (realValue === 0) return 'Valor a ser definido';\n  try {\n    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: currencyCode }).format(realValue);\n  } catch (e) {\n    return `${currencyCode} ${realValue.toFixed(2)}`;\n  }\n};\n\n// =================================================================\n// 3. FORMATTERS (PADRONIZADOS COM O OUTRO FLUXO)\n// =================================================================\nconst formatters = {\n  // BotÃµes\n  buttons: () => {\n    const header = convertMarkdown(c?.header?.title ?? '');\n    const body   = convertMarkdown(c?.body?.text ?? '');\n    const footer = convertMarkdown(c?.footer?.text ?? '');\n    \n    const buttonsArray = c?.InteractiveMessage?.NativeFlowMessage?.buttons ?? [];\n    \n    const options = buttonsArray.map(btn => {\n      let params = {};\n      try { params = JSON.parse(btn.buttonParamsJSON ?? '{}'); } catch (e) {}\n      const text = convertMarkdown(params.display_text ?? 'BotÃ£o');\n      \n      if (btn.name === 'cta_url' && params.url) return `* [${text}](${params.url}) ðŸ”—`;\n      if (btn.name === 'cta_call' && params.phone_number) return `* ${text} (${params.phone_number}) ðŸ“ž`;\n      return `* ${text}`;\n    }).join('\\n');\n\n    const direction = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ”˜ _Mensagem com BotÃµes (${direction}):_`;\n    const tipFooter = !msg.fromMe ? `_Dica: Acesse pelo celular ou web para responder._` : '';\n\n    return [headerTitle, '---', header, body, footer, options, tipFooter].filter(Boolean).join('\\n\\n');\n  },\n\n  // Listas\n  list: () => {\n    const direction = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ“‹ _Mensagem com Lista (${direction}):_`;\n    const tipFooter = !msg.fromMe ? `_Dica: Acesse pelo celular ou web para responder._` : '';\n\n    const description = convertMarkdown(c?.description ?? 'Lista');\n    const footer      = convertMarkdown(c?.footerText ?? '');\n    const button      = convertMarkdown(c?.buttonText ?? '');\n    \n    const options = (c?.sections ?? []).map(section => {\n      const sectionTitle = `\\n**${convertMarkdown(section.title ?? 'SeÃ§Ã£o')}**`;\n      const rows = (section.rows ?? []).map(row => {\n        const rowTitle = convertMarkdown(row.title ?? 'OpÃ§Ã£o');\n        const rowDesc  = convertMarkdown(row.description ?? '');\n        return rowDesc ? `* **${rowTitle}** - _${rowDesc}_` : `* **${rowTitle}**`;\n      }).join('\\n');\n      return `${sectionTitle}\\n${rows}`;\n    }).join('\\n');\n\n    return [\n      headerTitle, '---', \n      `**${description}**`, \n      (button ? `*Texto do BotÃ£o:* ${button}` : ''), \n      options, \n      (footer ? `_${footer}_` : ''), \n      tipFooter\n    ].filter(Boolean).join('\\n\\n');\n  },\n\n  // Enquetes\n  poll: () => {\n    const pollData = c?.pollCreationMessageV3 ?? c?.pollCreationMessage;\n    if (!pollData) return 'Erro ao processar enquete.';\n\n    const question = convertMarkdown(pollData.name ?? 'Enquete');\n    const options = (pollData.options ?? []).map((opt, index) => \n      `${index + 1}. ${convertMarkdown(opt.optionName ?? 'OpÃ§Ã£o')}`\n    ).join('\\n');\n\n    const count  = pollData.selectableOptionsCount ?? 0;\n    const footer = (count === 0) \n      ? `_(Permitido votar em mÃºltiplas opÃ§Ãµes)_` \n      : `_(Permitido votar em ${count} opÃ§Ã£o${count > 1 ? 's' : ''})_`;\n\n    const direction = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸ“Š _Enquete ${direction}:_`;\n    const tipFooter = !msg.fromMe ? `_Dica: Acesse pelo celular ou web para responder._` : '';\n\n    return [headerTitle, '---', `**${question}**`, options, footer, tipFooter].filter(Boolean).join('\\n\\n');\n  },\n\n  // Contatos\n  contacts: () => {\n    const parseVCard = (vcardString, displayName) => {\n      const getField = (f) => (vcardString.match(new RegExp(`^${f}(?:;.*)?:([^\\\\n\\\\r]+)`, 'm')) || [])[1]?.replace(/;$/, '').trim();\n      const getPhones = () => [...vcardString.matchAll(/TEL.*:([^\\n\\\\r]+)/g)].map(m => m[1].trim());\n\n      const name  = convertMarkdown(displayName ?? 'Contato');\n      const org   = getField('ORG');\n      const email = getField('EMAIL');\n      const url   = getField('URL');\n      const phones = getPhones();\n\n      const card = [`**${name}**`];\n      if (org)   card.push(`ðŸ¢ ${convertMarkdown(org)}`);\n      phones.forEach(p => card.push(`ðŸ“ž ${convertMarkdown(p)}`));\n      if (email) card.push(`ðŸ“§ ${convertMarkdown(email)}`);\n      if (url)   card.push(`ðŸŒ [${convertMarkdown(url)}](${url})`);\n      return card.join('\\n');\n    };\n\n    let vcards = [];\n    if (msg.messageType === 'ContactsArrayMessage') {\n      vcards = (c.contacts ?? []).map(ct => parseVCard(ct.vcard, ct.displayName));\n    } else if (msg.messageType === 'ContactMessage') {\n      vcards = [parseVCard(c.vcard ?? '', c.displayName ?? 'Contato')];\n    }\n\n    if (vcards.length === 0) return 'Erro ao processar contato.';\n\n    const title = vcards.length > 1 ? 'Contatos' : 'Contato';\n    const headerTitle = msg.fromMe \n      ? `ðŸ‘¤ _${title} Enviado${vcards.length > 1 ? 's' : ''}:_`\n      : `ðŸ‘¤ _${title} Recebido${vcards.length > 1 ? 's' : ''}_ (de **${msg?.senderName ?? 'Contato'}**):`;\n\n    return [headerTitle, '---', vcards.join('\\n\\n---\\n\\n')].filter(Boolean).join('\\n\\n');\n  },\n\n  // Evento\n  event: () => {\n    const name        = convertMarkdown(c?.name ?? 'Evento');\n    const description = convertMarkdown(c?.description ?? '');\n    const location    = convertMarkdown(c?.location?.name ?? '');\n    const joinLink    = c?.joinLink ?? '';\n\n    const formatTs = (ts) => {\n      if (!ts) return null;\n      return new Date(ts * 1000).toLocaleString('pt-BR', { \n        day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' \n      });\n    };\n\n    const details = [];\n    const start = formatTs(c?.startTime);\n    const end = formatTs(c?.endTime);\n\n    if (start) details.push(`ðŸ“† **InÃ­cio:** ${start}`);\n    if (end)   details.push(`ðŸ“† **Fim:** ${end}`);\n    if (location) details.push(`ðŸ“ **Local:** ${location}`);\n\n    if (joinLink) {\n      if (joinLink.includes('/video/')) details.push(`ðŸ“¹ [Entrar na Chamada de VÃ­deo](${joinLink})`);\n      else if (joinLink.includes('/audio/') || joinLink.includes('/voice/')) details.push(`ðŸ“ž [Entrar na Chamada de Voz](${joinLink})`);\n      else details.push(`ðŸ”— [Link para o Evento](${joinLink})`);\n    }\n\n    const headerTitle = msg.fromMe ? `ðŸ“† _Evento Criado:_` : `ðŸ“† _Evento Recebido_ (de **${msg?.senderName ?? 'Contato'}**):`;\n    const cancelText = (c?.isCanceled === true) ? `\\n**-- EVENTO CANCELADO --**` : '';\n\n    return [headerTitle, '---', `**${name}**`, description ? `*${description}*` : '', details.join('\\n'), cancelText].filter(Boolean).join('\\n\\n');\n  },\n\n  // Produtos\n  product: () => {\n    const product = c?.product;\n    if (!product) return 'Erro ao processar produto.';\n\n    const title       = convertMarkdown(product.title ?? 'Produto');\n    const description = convertMarkdown(product.description ?? '');\n    const productLink = product.URL ?? '';\n    const imageURL    = product.productImage?.URL ?? '';\n    const currency    = product.currencyCode ?? 'BRL';\n    const price       = formatCurrency(product.priceAmount1000,      1000, currency);\n    const salePrice   = formatCurrency(product.salePriceAmount1000, 1000, currency);\n    \n    let priceString = (salePrice && salePrice !== 'Valor a ser definido') \n      ? `\\n**${salePrice}** (de ~~${price}~~)` \n      : (price && price !== 'Valor a ser definido' ? `\\n**${price}**` : '');\n\n    const headerTitle = msg.fromMe ? `ðŸ›’ _Produto Enviado:_` : `ðŸ›’ _Produto Recebido_ (de **${msg?.senderName ?? 'Contato'}**):`;\n\n    const cardBody = [\n      (imageURL ? `![Imagem do Produto](${imageURL})` : ''),\n      `**${title}**`,\n      (description ? `*${description}*` : ''),\n      priceString,\n      (productLink ? `\\n[Ver Produto na Loja](${productLink}) ðŸ”—` : '')\n    ].filter(Boolean).join('\\n');\n\n    return [headerTitle, '---', cardBody].filter(Boolean).join('\\n\\n');\n  },\n\n  // CatÃ¡logo\n  catalog: () => {\n    const title       = convertMarkdown(c?.title ?? 'CatÃ¡logo');\n    const description = convertMarkdown(c?.description ?? '');\n    const text        = convertMarkdown(c?.text ?? '');\n\n    const headerTitle = msg.fromMe ? `ðŸ§¾ _CatÃ¡logo Enviado:_` : `ðŸ§¾ _CatÃ¡logo Recebido_ (de **${msg?.senderName ?? 'Contato'}**):`;\n\n    return [\n      headerTitle, '---', `**${title}**`, \n      (description ? `\\n*${description}*` : ''), \n      (text ? `\\n${text}` : '')\n    ].filter(Boolean).join('\\n\\n');\n  },\n\n  // PIX\n  pix: (params) => {\n    const pixData    = params.payment_settings?.[0]?.pix_static_code ?? {};\n    const amountData = params.total_amount ?? {};\n    const currency   = params.currency ?? 'BRL';\n\n    const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\n    const pixKey       = convertMarkdown(pixData.key ?? 'Chave nÃ£o informada');\n    const keyType      = convertMarkdown(pixData.key_type ?? '');\n    const amount       = formatCurrency(amountData.value, amountData.offset, currency);\n\n    const headerTitle = msg.fromMe ? `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Enviada):_` : `ðŸ’¸ _SolicitaÃ§Ã£o de PIX (Recebida de **${msg?.senderName ?? 'Contato'}**):_`;\n    const tip = !msg.fromMe ? `_Dica: Para pagar, copie a chave PIX e use o app do seu banco._` : '';\n\n    const body = [\n      `**Valor:** ${amount}`,\n      `\\n**Recebedor:** ${merchantName}`,\n      `**Chave PIX:** \\`${pixKey}\\` (${keyType})`\n    ].join('\\n');\n\n    return [headerTitle, '---', body, tip].filter(Boolean).join('\\n\\n');\n  },\n\n  // Carrinho\n  cart: (params) => {\n    const currency = params.currency ?? 'BRL';\n    const order    = params.order ?? {};\n    \n    const itemsString = (order.items ?? []).map(item => {\n      const name = convertMarkdown(item.name ?? 'Item');\n      const quantity = item.quantity ?? 1;\n      const price = formatCurrency(item.amount?.value, item.amount?.offset, currency);\n      return `* ${quantity}x ${name} (${price})`;\n    }).join('\\n');\n\n    const subtotal = formatCurrency(order.subtotal?.value, order.subtotal?.offset, currency);\n    const discount = formatCurrency(order.discount?.value, order.discount?.offset, currency);\n    const total    = formatCurrency(params.total_amount?.value, params.total_amount?.offset, currency);\n\n    const pixSettings = params.payment_settings?.[0] ?? {};\n    const pixData     = pixSettings.pix_static_code ?? pixSettings.pix_dynamic_code ?? {};\n    const merchantName = convertMarkdown(pixData.merchant_name ?? 'PIX');\n    const pixKey       = convertMarkdown(pixData.key ?? pixData.code ?? 'Chave nÃ£o informada');\n    const keyType      = convertMarkdown(pixData.key_type ?? (pixSettings.type === 'pix_dynamic_code' ? 'DinÃ¢mico' : ''));\n\n    const headerTitle = msg.fromMe ? `ðŸ›’ _Pedido Enviado:_` : `ðŸ›’ _Novo Pedido Recebido_ (de **${msg?.senderName ?? 'Contato'}**):`;\n\n    const bodyText = convertMarkdown(c?.body?.text ?? '');\n    const totals = [];\n    if (subtotal) totals.push(`**Subtotal:** ${subtotal}`);\n    if (discount && order.discount?.value > 0) totals.push(`**Desconto:** ${discount}`);\n    if (total) totals.push(`**Total:** **${total}**`);\n\n    let pixInfo = '';\n    if(pixKey !== 'Chave nÃ£o informada') {\n      pixInfo = `\\n**Para Pagar (PIX):**\\n**Recebedor:** ${merchantName}\\n**Chave PIX:** \\`${pixKey}\\` (${keyType})`;\n    }\n    \n    const tip = !msg.fromMe ? `_Dica: Para pagar, copie a chave PIX e use o app do seu banco._` : '';\n\n    return [\n      headerTitle, '---', '**Resumo do Pedido:**', \n      (bodyText ? `*${bodyText}*` : ''),\n      itemsString,\n      totals.join('\\n'),\n      pixInfo,\n      tip\n    ].filter(Boolean).join('\\n\\n');\n  },\n\n  // LocalizaÃ§Ã£o EstÃ¡tica\n  location: () => {\n    const lat     = c?.degreesLatitude;\n    const long    = c?.degreesLongitude;\n    const name    = convertMarkdown(c?.name ?? '');\n    const address = convertMarkdown(c?.address ?? '');\n    const mapLink = (lat && long) ? `https://maps.google.com/?q=${lat},${long}` : '';\n\n    const headerTitle = msg.fromMe ? `ðŸ“ _LocalizaÃ§Ã£o Enviada:_` : `ðŸ“ _LocalizaÃ§Ã£o Recebida_ (de **${msg?.senderName ?? 'Contato'}**):`;\n\n    const body = [];\n    if (name)    body.push(`**${name}**`);\n    if (address) body.push(`*${address}*`);\n    if (lat)     body.push(`**Latitude:** \\`${lat}\\``);\n    if (long)    body.push(`**Longitude:** \\`${long}\\``);\n\n    const linkText = mapLink ? `[Ver LocalizaÃ§Ã£o no Google Maps](${mapLink}) ðŸŒ` : '';\n\n    return [headerTitle, '---', body.join('\\n'), linkText].filter(Boolean).join('\\n\\n');\n  },\n\n  // LocalizaÃ§Ã£o em Tempo Real\n  liveLocation: () => {\n    const lat  = c?.degreesLatitude;\n    const long = c?.degreesLongitude;\n    const comm = c?.caption;\n    const mapLink = (lat && long) ? `https://maps.google.com/?q=${lat},${long}` : '';\n    const senderName = msg?.senderName ?? 'Contato';\n    const headerTitle = msg.fromMe \n      ? `ðŸ“ _VocÃª iniciou o compartilhamento de localizaÃ§Ã£o em tempo real._` \n      : `ðŸ“ _${senderName} estÃ¡ compartilhando a localizaÃ§Ã£o em tempo real._`;\n\n    const body = [];\n    if (lat)  body.push(`**Latitude Inicial:** \\`${lat}\\``);\n    if (long) body.push(`**Longitude Inicial:** \\`${long}\\``);\n    if (comm) body.push(`**ComentÃ¡rio:** ${comm}`);\n\n    const linkText = mapLink ? `[Ver a localizaÃ§Ã£o inicial no Google Maps](${mapLink}) ðŸŒ` : '';\n    const warning = `*A localizaÃ§Ã£o atual e em tempo real nÃ£o pode ser exibida no Chatwoot.*\\n_Acesse o WhatsApp no celular ou web para acompanhar._`;\n\n    return [headerTitle, '---', body.join('\\n'), linkText, warning].filter(Boolean).join('\\n\\n');\n  },\n\n  // Carrossel (ATUALIZADO COM O FORMATO NOVO)\n  carousel: () => {\n    const carouselData = c?.InteractiveMessage?.CarouselMessage;\n    const cards        = carouselData?.cards ?? [];\n    if (cards.length === 0) return 'Erro ao processar carrossel.';\n\n    const mainBody = convertMarkdown(c?.body?.text ?? '');\n\n    const formattedCards = cards.map((card, index) => {\n      const bodyText = convertMarkdown(card?.body?.text ?? '');\n\n      let buttonText = 'Ver opÃ§Ã£o';\n      try {\n        const btn = card?.InteractiveMessage?.NativeFlowMessage?.buttons?.[0];\n        if (btn) buttonText = convertMarkdown(JSON.parse(btn.buttonParamsJSON).display_text ?? 'Ver opÃ§Ã£o');\n      } catch (e) {}\n\n      const cardParts = [`**${index + 1}. ${buttonText}**`];\n      if (bodyText) {\n        const bodyLines = bodyText.split('\\n').map(line => `> ${line}`);\n        cardParts.push(bodyLines.join('\\n'));\n      }\n      return cardParts.join('\\n');\n    }).join('\\n\\n---\\n\\n');\n\n    const direction   = msg.fromMe ? 'Enviada' : 'Recebida';\n    const headerTitle = `ðŸŽ  _Mensagem em Carrossel (${direction}):_`;\n    const tipFooter = !msg.fromMe ? `_Dica: Acesse pelo celular ou web para responder._` : '';\n\n    // Usando o mesmo padrÃ£o limpo e adicionando o separador ---\n    return [\n        headerTitle, \n        '---', // SEPARADOR ADICIONADO\n        (mainBody ? `**${mainBody}**` : ''), \n        formattedCards, \n        tipFooter\n    ].filter(Boolean).join('\\n\\n');\n  },\n};\n\n// =================================================================\n// 4. PROCESSA CONTEÃšDO EM TEXTO (LÃ“GICA PRINCIPAL)\n// =================================================================\nlet processedContent = '';\n\nif (c?.InteractiveMessage?.CarouselMessage) {\n  processedContent = formatters.carousel();\n} else if (c?.InteractiveMessage?.NativeFlowMessage) {\n  const button     = c.InteractiveMessage.NativeFlowMessage.buttons?.[0];\n  const buttonName = button?.name;\n  let params;\n  try { params = JSON.parse(button?.buttonParamsJSON ?? '{}'); } catch (e) { params = {}; }\n\n  if (buttonName === 'payment_info') processedContent = formatters.pix(params);\n  else if (buttonName === 'review_and_pay') processedContent = formatters.cart(params);\n  else processedContent = formatters.buttons();\n} else if (c?.sections) {\n  processedContent = formatters.list();\n} else if (['PollCreationMessageV3', 'PollCreationMessage'].includes(msg?.messageType)) {\n  processedContent = formatters.poll();\n} else if (msg?.messageType === 'PollUpdateMessage') {\n  const voteText = convertMarkdown(msg?.vote ?? '');\n  if (!voteText) processedContent = '';\n  else if (msg.fromMe) processedContent = `ðŸ“¤ _Voto Enviado:_\\n\\n**${voteText}**`;\n  else {\n    const senderName = msg?.senderName ?? 'Contato';\n    processedContent = `ðŸ“¥ _Voto Recebido_ (de **${senderName}**):\\n\\n**${voteText}**`;\n  }\n} else if (msg?.buttonOrListid) {\n  const selectionText = convertMarkdown(String(c?.selectedDisplayText ?? c?.title ?? ''));\n  if (!selectionText) processedContent = '';\n  else if (msg.fromMe) processedContent = `ðŸ“¤ _SeleÃ§Ã£o Enviada:_\\n\\n**${selectionText}**`;\n  else {\n    const senderName = msg?.senderName ?? 'Contato';\n    processedContent = `ðŸ“¥ _OpÃ§Ã£o Selecionada_ (por **${senderName}**):\\n\\n**${selectionText}**`;\n  }\n} else if (['ContactMessage', 'ContactsArrayMessage'].includes(msg.messageType)) {\n  processedContent = formatters.contacts();\n} else if (msg?.messageType === 'EventMessage') {\n  processedContent = formatters.event();\n} else if (msg?.messageType === 'LocationMessage') {\n  processedContent = formatters.location();\n} else if (msg?.messageType === 'ProductMessage') {\n  processedContent = formatters.product();\n} else if (msg?.messageType === 'ExtendedTextMessage' && msg.mediaType === 'cataloglink') {\n  processedContent = formatters.catalog();\n} else if (msg?.messageType === 'LiveLocationMessage') {\n  processedContent = formatters.liveLocation();\n} else if (msg?.messageType === 'ReactionMessage') {\n  const reactionText = String(msg?.text ?? c?.text ?? '');\n  processedContent   = convertMarkdown(reactionText);\n} else if (['ImageMessage','VideoMessage','DocumentMessage'].includes(msg?.messageType)) {\n  const caption = String(c?.caption ?? '');\n  processedContent = convertMarkdown(caption);\n} else {\n  const commonText = (\n    String(msg?.text ?? '').trim() ||\n    String(msg?.content?.text ?? '').trim() ||\n    ''\n  );\n  processedContent = convertMarkdown(commonText);\n}\n\n// =================================================================\n// 5. TRATAMENTO FINAL PARA DELEÃ‡ÃƒO (MENSAGEM EXCLUÃDA)\n// =================================================================\n\n// Dados originais\nconst deletedMessage     = msg;\nconst originalAttributes = deletedMessage.content_attributes;\nconst sendPayload        = deletedMessage.sendPayload || {};\nconst docName            = sendPayload.docName || '';\nconst rawType            = sendPayload.type || '';\n\n// ConteÃºdo base para riscar\nconst originalContent =\n  processedContent ||\n  deletedMessage.text ||\n  deletedMessage.content?.caption ||\n  deletedMessage.sendPayload?.text ||\n  '';\n\n// Parse dos atributos\nlet parsedAttributes = {};\nif (typeof originalAttributes === 'string') {\n  try {\n    parsedAttributes = JSON.parse(originalAttributes);\n  } catch (e) {\n    parsedAttributes = {};\n  }\n} else if (typeof originalAttributes === 'object' && originalAttributes !== null) {\n  parsedAttributes = originalAttributes;\n}\n\n// Flag de deletado\nparsedAttributes.deleted = true;\nconst newAttributesString = JSON.stringify(parsedAttributes);\n\n// ============================================\n// CORREÃ‡ÃƒO DE RISCADO (MANTER LINHAS)\n// ============================================\nlet textPart = '';\nif (originalContent && String(originalContent).trim().length > 0) {\n  // Divide o texto por quebras de linha\n  const lines = String(originalContent).split(/\\r?\\n/);\n  \n  const struckLines = lines.map(line => {\n    // Se a linha for apenas um separador ou vazia, mantÃ©m como estÃ¡ (nÃ£o risca)\n    if (line.trim() === '---' || line.trim() === '') {\n      return line;\n    }\n    // Caso contrÃ¡rio, aplica o riscado\n    return `~~${line}~~`;\n  });\n\n  textPart = struckLines.join('\\n');\n}\n\n// Info de arquivo\nlet filePart = '';\n\n// TIPOS que realmente representam mÃ­dia/arquivo\nconst allowedTypes = ['image', 'video', 'audio', 'ptt', 'file', 'document'];\n\nif (rawType && allowedTypes.includes(rawType)) {\n  const typeMap = {\n    image:    'Imagem',\n    video:    'VÃ­deo',\n    audio:    'Ãudio',\n    ptt:      'Ãudio',\n    file:     'Documento',\n    document: 'Documento',\n  };\n\n  const translatedType = typeMap[rawType] || rawType;\n  filePart = `\\n\\nðŸ“Ž *${translatedType}*: ${docName ? '~~' + docName + '~~' : ''}`;\n}\n\n// ==================================================\n// AQUI ESTÃ A CORREÃ‡ÃƒO: ADICIONAMOS O SEPARADOR FIXO\n// ==================================================\nconst newContent =\n  'ðŸš« _Mensagem excluÃ­da_: ' +\n  '\\n\\n---\\n\\n' + // Separador adicionado explicitamente aqui\n  (textPart ? textPart : '') +\n  filePart;\n\n// Resolve o message_id (tenta em vÃ¡rios lugares, incluindo o node \"processedData\")\nconst messageIdFromProcessed =\n  $('processedData')?.item?.json?.data?.message_id ?? null;\n\nconst messageId =\n  root?.data?.message_id ??\n  root?.message_id ??\n  deletedMessage?.message_id ??\n  messageIdFromProcessed ??\n  null;\n\n// =================================================================\n// 6. RETORNO DO ITEM\n// =================================================================\nitem.json = {\n  message_id:               messageId,\n  new_content:              newContent,\n  new_attributes:           newAttributesString,\n  original_rendered_content: processedContent,\n};\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        1168
      ],
      "id": "a3a27fa9-ec6d-4a9e-9b59-446885fe7c45",
      "name": "messageDeletedPrepare"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "67b615a4-6620-4878-a354-1b740d8970e2",
              "leftValue": "={{ $('processedData')?.item?.json?.data?.direction }}",
              "rightValue": "outgoing",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1744,
        1168
      ],
      "id": "035aa8d2-0c7b-4bf0-8d86-8d8b55b72474",
      "name": "messageDeleteVerify"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.api.base_url }}/message/delete",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('normalizedData')?.item?.json?.api?.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"id\": \"{{ $('processedData')?.item?.json?.data?.source_id }}\"\n}",
        "options": {}
      },
      "id": "400a5870-54f8-49cf-be03-2e3a132e8a09",
      "name": "messageDelete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1920,
        1088
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('messageDeletedPrepare')?.item?.json?.message_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "sent"
            }
          ]
        },
        "options": {}
      },
      "id": "76943f7a-5268-4747-a163-c00c4d46b70f",
      "name": "messageDeletedPatch",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2272,
        1168
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "baseUrl",
              "value": "={{ $('normalizedData')?.item?.json?.chatwoot?.base_url ?? '' }}"
            },
            {
              "key": "accountId",
              "value": "={{ $('normalizedData')?.item?.json?.chatwoot?.account_id ?? '' }}"
            },
            {
              "key": "inboxId",
              "value": "={{ $('normalizedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"
            },
            {
              "key": "contactId",
              "value": "={{ $('normalizedData').item?.json?.contact?.contact_id ?? '' }}"
            },
            {
              "key": "contactIdentifier",
              "value": "={{ $('normalizedData')?.item?.json?.contact?.identifier ?? '' }}"
            },
            {
              "key": "conversationId",
              "value": "={{ $('normalizedData')?.item?.json?.data?.conversation_id ?? '' }}"
            },
            {
              "key": "conversationStatus",
              "value": "={{ $('normalizedData')?.item?.json?.data?.status ?? '' }}"
            },
            {
              "key": "messageId",
              "value": "={{ $('normalizedData')?.item?.json?.data?.message_id ?? '' }}"
            },
            {
              "key": "messageType",
              "value": "={{ $('normalizedData')?.item?.json?.data?.message_type ?? '' }}"
            },
            {
              "key": "messageDirection",
              "value": "={{ $('normalizedData')?.item?.json?.data?.direction ?? '' }}"
            },
            {
              "key": "eventType",
              "value": "={{ $('normalizedData')?.item?.json?.data?.event_type ?? '' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        1392,
        224
      ],
      "id": "4b794367-d346-43bc-94c9-cf5ad7924ba5",
      "name": "executionData1"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "baseUrl",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"
            },
            {
              "key": "accountId",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"
            },
            {
              "key": "inboxId",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"
            },
            {
              "key": "contactId",
              "value": "={{ $('processedData')?.item?.json?.contact.contact_id ?? '' }}"
            },
            {
              "key": "contactIdentifier",
              "value": "={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"
            },
            {
              "key": "conversationId",
              "value": "={{ $('processedData').item.json.data.conversation_id ?? '' }}"
            },
            {
              "key": "conversationStatus",
              "value": "={{ $('processedData')?.item?.json?.data?.status ?? '' }}"
            },
            {
              "key": "messageId",
              "value": "={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"
            },
            {
              "key": "messageType",
              "value": "={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"
            },
            {
              "key": "messageDirection",
              "value": "={{ $('processedData')?.item?.json?.data?.direction ?? '' }}"
            },
            {
              "key": "eventType",
              "value": "={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        1040,
        816
      ],
      "id": "2b31c933-dd45-4318-8ae1-f7511b832e50",
      "name": "executionData2"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "baseUrl",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.base_url ?? '' }}"
            },
            {
              "key": "accountId",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.account_id ?? '' }}"
            },
            {
              "key": "inboxId",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.inbox_id ?? '' }}"
            },
            {
              "key": "contactId",
              "value": "={{ $('processedData')?.item?.json?.contact?.contact_id ?? '' }}"
            },
            {
              "key": "contactIdentifier",
              "value": "={{ $('processedData')?.item?.json?.contact?.identifier ?? '' }}"
            },
            {
              "key": "conversationId",
              "value": "={{ $('processedData')?.item?.json?.data?.conversation_id ?? '' }}"
            },
            {
              "key": "conversationStatus",
              "value": "={{ $('processedData')?.item?.json?.data?.status ?? '' }}"
            },
            {
              "key": "messageId",
              "value": "={{ $('processedData')?.item?.json?.data?.message_id ?? '' }}"
            },
            {
              "key": "messageType",
              "value": "={{ $('processedData')?.item?.json?.data?.message_type ?? '' }}"
            },
            {
              "key": "messageDirection",
              "value": "={{ $('processedData')?.item?.json?.data?.direction ?? '' }}"
            },
            {
              "key": "eventType",
              "value": "={{ $('processedData')?.item?.json?.data?.event_type ?? '' }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        2960,
        528
      ],
      "id": "2d3fa6d6-04da-4b02-a210-b1ddb3cacc23",
      "name": "executionData3"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('processedData')?.item?.json?.data?.message_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "delivered"
            }
          ]
        },
        "options": {}
      },
      "id": "b2f2fcb0-6ff4-4241-b2a1-c667a92018f1",
      "name": "messageEditedDelivered",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2272,
        688
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('processedData')?.item?.json?.chatwoot?.base_url }}/api/{{ $('processedData')?.item?.json?.chatwoot?.api_version }}/accounts/{{ $('processedData')?.item?.json?.chatwoot?.account_id}}/conversations/{{ $('processedData')?.item?.json?.data?.conversation_id }}/messages/{{ $('processedData')?.item?.json?.data?.message_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('processedData')?.item?.json?.chatwoot?.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "status",
              "value": "sent"
            }
          ]
        },
        "options": {}
      },
      "id": "a001d4c4-d236-445e-9d2b-93bd187a2142",
      "name": "messageEditedSent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2448,
        688
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('normalizedData')?.item?.json?.api?.base_url }}/message/presence",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "token",
              "value": "={{ $('normalizedData')?.item?.json?.api?.token }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $('normalizedData')?.item?.json?.contact?.identifier }}\",\n  \"presence\": \"{{ (() => { const evt = $('webhookDataChatwoot')?.item?.json?.body?.event; const map = { 'conversation_typing_on': 'composing', 'conversation_typing_off': 'paused' }; return map[evt] ?? ''; })() }}\"\n}",
        "options": {}
      },
      "id": "fb01eb45-9cb4-49dc-a246-c5190779ff18",
      "name": "messagePresenceUpdate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1392,
        1328
      ],
      "retryOnFail": true
    }
  ],
  "connections": {
    "messageVerify": {
      "main": [
        [
          {
            "node": "messageTextSend",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "messageMediaSplit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "webhookDataChatwoot": {
      "main": [
        [
          {
            "node": "getVariables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "getVariables": {
      "main": [
        [
          {
            "node": "messageTypeFilter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageDeletedUpdate": {
      "main": [
        [
          {
            "node": "messageDeletedPatch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageSentVerify": {
      "main": [
        [
          {
            "node": "messageVerify",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "messageDeletedFind",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "messagePresenceUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageTypeFilter": {
      "main": [
        [
          {
            "node": "normalizedData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactCreate": {
      "main": [
        [
          {
            "node": "contactIdentify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactFind": {
      "main": [
        [
          {
            "node": "contactAction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactUpdate": {
      "main": [
        [
          {
            "node": "contactIdentify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactIdentify": {
      "main": [
        [
          {
            "node": "processedData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactValidation": {
      "main": [
        [
          {
            "node": "contactVerify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactAction": {
      "main": [
        [
          {
            "node": "contactCreate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contactIdentify",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contactUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactVerify": {
      "main": [
        [
          {
            "node": "contactFind",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contactMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "identifierVerify": {
      "main": [
        [
          {
            "node": "contactFind",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contactFind",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contactValidation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "contactValidation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "contactMessage": {
      "main": [
        [
          {
            "node": "endProcess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageTextSend": {
      "main": [
        [
          {
            "node": "messageTextUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaSend": {
      "main": [
        [
          {
            "node": "messageMediaVerify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaFields": {
      "main": [
        [
          {
            "node": "messageMediaSend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "createMessageInChatwoot": {
      "main": [
        [
          {
            "node": "messageMediaUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaDownload": {
      "main": [
        [
          {
            "node": "createMessageInChatwoot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaVerify": {
      "main": [
        [
          {
            "node": "messageMediaDownload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "messageMediaLoop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaUpdate": {
      "main": [
        [
          {
            "node": "messageMediaLoop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageTextUpdate": {
      "main": [
        [
          {
            "node": "messageEditedDelivered",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "processedData": {
      "main": [
        [
          {
            "node": "messageSentVerify",
            "type": "main",
            "index": 0
          },
          {
            "node": "executionData2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "normalizedData": {
      "main": [
        [
          {
            "node": "executionData1",
            "type": "main",
            "index": 0
          },
          {
            "node": "identifierVerify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaSplit": {
      "main": [
        [
          {
            "node": "messageMediaLoop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaLoop": {
      "main": [
        [
          {
            "node": "messageMediaRemove",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "messageMediaFields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageMediaRemove": {
      "main": [
        [
          {
            "node": "messageTextUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageDeletedFind": {
      "main": [
        [
          {
            "node": "messageDeletedPrepare",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageDeletedPrepare": {
      "main": [
        [
          {
            "node": "messageDeleteVerify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageDeleteVerify": {
      "main": [
        [
          {
            "node": "messageDelete",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "messageDeletedUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageDelete": {
      "main": [
        [
          {
            "node": "messageDeletedUpdate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageDeletedPatch": {
      "main": [
        [
          {
            "node": "endProcess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "endProcess": {
      "main": [
        [
          {
            "node": "executionData3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageEditedDelivered": {
      "main": [
        [
          {
            "node": "messageEditedSent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messageEditedSent": {
      "main": [
        [
          {
            "node": "endProcess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "messagePresenceUpdate": {
      "main": [
        [
          {
            "node": "endProcess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "bec3d7de-cf05-42a7-89c4-ca0c45566aef",
  "activeVersionId": "bec3d7de-cf05-42a7-89c4-ca0c45566aef",
  "versionCounter": 20,
  "triggerCount": 1,
  "tags": [],
  "shared": [
    {
      "updatedAt": "2026-02-21T13:12:23.264Z",
      "createdAt": "2026-02-21T13:12:23.264Z",
      "role": "workflow:owner",
      "workflowId": "ymfHenvcNrAnNvOR",
      "projectId": "C5aD6UPns470KPiT",
      "project": {
        "updatedAt": "2026-02-18T10:56:45.246Z",
        "createdAt": "2026-02-12T20:28:11.259Z",
        "id": "C5aD6UPns470KPiT",
        "name": "Ramon Duarte <ramon26player@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "creatorId": "03aed1aa-1435-40b4-9d79-a70ab09e1ab8"
      }
    }
  ]
}